- name: Stop zabbix_agent
  ignore_errors: yes
  systemd: 
    name: "zabbix-agent"
    enabled: no
    state: stopped

- name: Check if zabbix-agent2 package is installed
  command: dpkg-query -W zabbix-agent2
  register: zabbix_agent2_check_result # 执行返回结果赋值给zabbix_agent2_check_result变量，执行返回结果是json对象
  failed_when: zabbix_agent2_check_result.rc > 1 # zabbix_agent2_check_result.rc等于0表示执行成功
  changed_when: zabbix_agent2_check_result.rc == 1
- name: Download zabbix5.0 package
  get_url: 
    url=https://repo.zabbix.com/zabbix/5.0/ubuntu/pool/main/z/zabbix-release/zabbix-release_5.0-1+focal_all.deb
    dest="/tmp/zabbix-release_5.0-1+focal_all.deb"
  when: zabbix_agent2_check_result.rc == 1
- name: Install zabbix5.0 package
  apt: deb="/tmp/zabbix-release_5.0-1+focal_all.deb"
  when: zabbix_agent2_check_result.rc == 1

- name: Install zabbi-agent2 Service
  apt:
    name: zabbix-agent2
    state: present

- name: Config zabbix_agent2.conf
  template: src=./files/zabbix_agent2.conf.j2 dest=/etc/zabbix/zabbix_agent2.conf

- name: Start zabbix_agent2 Service
  systemd: 
    name: "zabbix-agent2"
    enabled: yes
    state: restarted

